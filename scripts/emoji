#!/usr/bin/bash
################################# About ################################
## Author: Simon D. Woodtli
## Thanks to u/rustyflavor on reddit for some neat modifications
## Project: https://github.com/SimonWoodtli/dotfiles/blob/main/scripts/emoji
## Script Name: emoji
## License:  Apache-2.0
## Dependencies: fzf, xclip, sed, cut, tr
################################# Setup ##############################
## 1. Copy script into your $PATH and chmod it
## 2. Run script once to populate database
## 3. Add to your ~/.vimrc: (rm # char at beginning)
################################# vimrc ################################
#"ex-command fzf window:
#command! Emoji call fzf#run(fzf#wrap({'source': 'cat "$HOME/.local/share/emojidb/emoji.v15.1"', 'sink': function('InsertFirstCharAtCursor')}))
#"print function:
#function! InsertFirstCharAtCursor(text)
#  let rmTxt = split(a:text, ' ')
#  let firstChar = get(rmTxt, 0)
#  execute "normal! i" . firstChar . "\<Esc>"
#endfunction
#"leader-command: (adjust to what you like)
#nnoremap <silent> <leader><leader>e :Emoji<CR>
################################ Script ################################
emojidb="$HOME/.local/share/emojidb/emoji.v15.1"

_checkCommand() { command -v "$@" &>/dev/null; }
## Check if dependencies are installed
_checkDependencies() {
  local -a dependencies=( fzf curl )
  local -a missingDependencies=()
  for dependency in "${dependencies[@]}"; do
    _checkCommand "$dependency" || missingDependencies+=( "$dependency" )
  done
  if [[ -n "${missingDependencies[@]}" ]]; then
    echo "ERROR: Missing dependency(ies): "${missingDependencies[@]}""
    exit 1
  fi
}
## Fetch data and filter out unwanted data
_createEmojiList() {
  #update url manually if new release comes out
  local url="https://unicode.org/Public/emoji/15.1/emoji-test.txt" 
  mkdir -p "${emojidb%/*}"
  curl -s "$url" | sed '
      /^#/d          # remove comments
      /^\s*$/d       # remove empty lines
      /skin tone/d   # remove skin tones
      s/^[^#]*# //   # remove first column
      s/\bE[0-9.]\+// # remove E number
  ' > "$emojidb"
}
## Check if emojidb and emoji file are present or create them
_printEmojiCopyClipboard() {
  [[ -f "$emojidb" ]] || _createEmojiList
  local emoji=$(fzf < "$emojidb")
  emoji=${emoji%% *}
  ##FIXME Currently terminal does not support multibinary emojis with ZWJ
  printf "%s\n" "$emoji"
  if _checkCommand xclip; then
      printf %s "$emoji" | xclip -sel clipboard
  else
      printf "%s\n" "Install xclip for automatic copy to clipboard"
  fi
}
_checkDependencies && _printEmojiCopyClipboard
